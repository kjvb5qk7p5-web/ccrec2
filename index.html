<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Card Advisor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      max-width: 900px;
    }
    h1, h2, h3 {
      margin-bottom: 0.3rem;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    input, select, button, textarea {
      margin-top: 4px;
      padding: 6px 8px;
      font-size: 0.9rem;
    }
    input[type="number"] {
      width: 120px;
    }
    input[type="date"] {
      width: 150px;
    }
    select {
      min-width: 220px;
    }
    button {
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f4f4f4;
    }
    button.primary {
      background: #0b6efd;
      color: white;
      border-color: #0b6efd;
    }
    /* Bigger inputs & buttons only in the New Purchase section */
    .new-purchase-card input,
    .new-purchase-card select {
      font-size: 1.1rem;   /* tweak up or down to taste */
    }
    .new-purchase-card button {
      font-size: 1.1rem;   /* tweak up or down to taste */
    }
    /* Make the recommendation text bigger too */
    .new-purchase-card #recommendationBox {
      font-size: 1.2rem;
    }
    
    .new-purchase-card #reasonBox {
      font-size: 1.1rem;   /* slightly bigger than before, still secondary */
    }
    /* TABLE STYLING – updated for iPhone width */
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.85rem;
      table-layout: fixed; /* ensure fixed layout so widths are respected */
    }
    th, td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      text-align: left;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    th {
      background: #f7f7f7;
    }

    /* Column widths so it fits nicely on mobile
       1: Date, 2: Amount, 3: Category, 4: Channel, 5: Card Used
       Total = 100% */
    th:nth-child(1), td:nth-child(1) { width: 18%; } /* Date */
    th:nth-child(2), td:nth-child(2) { width: 14%; } /* Amount */
    th:nth-child(3), td:nth-child(3) { width: 24%; } /* Category */
    th:nth-child(4), td:nth-child(4) { width: 24%; } /* Channel */
    th:nth-child(5), td:nth-child(5) { width: 20%; } /* Card Used */

    #loggedTable {
    border-collapse: collapse;
    width: 100%;
    font-size: 0.5rem; /* adjust as small as you like */
    }

    #loggedTable th,
    #loggedTable td {
      padding: 2px 4px; /* optional: tighter padding to save space */
    }

    .muted {
      color: #777;
      font-size: 0.8rem;
    }
    .credit-met {
  color: green;
  font-weight: 600;
    }
    .inline {
      display: inline-block;
      margin-right: 12px;
    }
  </style>
</head>
<body>
  <h1>Which Card Should I Use?</h1>
  <p class="muted">
    Local brain for 4 cards: <br>
        &nbsp;&nbsp;&nbsp;- Chase Sapphire Reserve (CSR)<br>
        &nbsp;&nbsp;&nbsp;- United Quest (UQ)<br>
        &nbsp;&nbsp;&nbsp;- Marriott Bonvoy Brilliant (MB)<br>
        &nbsp;&nbsp;&nbsp;- Delta SkyMiles Amex Gold (DG)<br>
  </p>

  <!-- New purchase input -->
  <div class="card new-purchase-card">
    <h2>New Purchase</h2>
    <label>
      Amount ($)
      <input type="number" id="amount" min="0" step="0.01" />
    </label>

    <label>
      Date
      <input type="date" id="date" />
    </label>

    <label>
      Category
      <select id="category">
        <option value="dining">Dining / Restaurants</option>
        <option value="doordash">Doordash</option>
        <option value="lyft">Lyft</option>
        <option value="rideshare_other">Other rideshare (Uber, etc.)</option>
        <option value="united_flight">United flight</option>
        <option value="delta_flight_threshold">Delta flight – threshold chasing</option>
        <option value="delta_flight">Delta flight (not threshold)</option>
        <option value="other_flight">Other airline flight</option>
        <option value="marriott_hotel">Marriott hotel</option>
        <option value="renowned_hotel">Renowned hotel (United program)</option>
        <option value="delta_stays">Delta Stays hotel</option>
        <option value="other_hotel">Other hotel / lodging</option>
        <option value="stubhub">StubHub / viagogo</option>
        <option value="instacart">Instacart</option>
        <option value="streaming">Streaming</option>
        <option value="peloton">Peloton membership</option>
        <option value="other">Other / general</option>
      </select>
    </label>

    <div style="margin-top: 12px;">
      <button class="primary" id="btnRecommend">Get Card Recommendation</button>
      <button id="btnReset" type="button" style="margin-left:8px;">Reset</button>
    </div>

    <div id="recommendationSection" style="margin-top: 12px; display:none;">
      <div id="recommendationBox"></div>
      <div id="reasonBox"></div>

      <div style="margin-top: 10px;">
        <label>
          Card actually used (optional override)
          <select id="cardUsedSelect">
            <option value="">Use recommended card</option>
            <option value="CSR">CSR</option>
            <option value="UQ">United Quest</option>
            <option value="MB">Marriott Brilliant</option>
            <option value="DG">Delta Gold</option>
          </select>
        </label>

        <label>
          Channel actually used (optional override)
          <select id="channelUsedSelect">
            <!-- options populated dynamically based on category -->
          </select>
        </label>

        <div style="margin-top: 8px;">
          <button class="primary" id="btnSaveTx">Confirm &amp; Save Purchase</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Current month credit usage summary -->
  <div class="card">
    <h2>Current Month – Approx Credits Usage</h2>
    <div id="stateSummary" class="muted"></div>
  </div>

  <!-- Logged transactions -->
  <div class="card">
    <h2>Logged Purchases</h2>

    <!-- New show/hide toggle button -->
    <button id="toggleLogBtn" style="margin-bottom:8px;">
      Show
    </button>

    <!-- Everything below is hidden by default -->
    <div id="logContent" style="display:none;">
      <table id="loggedTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Amount</th>
            <th>Category</th>
            <th>Channel</th>
            <th>Card Used</th>
          </tr>
        </thead>
        <tbody id="txTableBody"></tbody>
      </table>

      <button id="btnClear" style="margin-top:10px;">
        Clear All Logged Purchases
      </button>

      <p class="muted">
        Stored in your browser’s localStorage. Clearing your browser data will wipe this.
      </p>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "cardAdvisorTxsV1";

    // Channel label mapping for human-readable text
    const CHANNEL_LABELS = {
      direct: "direct with the merchant",
      chase_travel: "via Chase Travel portal",
      lyft_app: "in the Lyft app",
      united: "on United.com / app",
      delta: "on Delta.com / app",
      renowned_chase: "via Renowned Hotels (Chase Travel)",
      delta_stays_platform: "on Delta Stays platform",
      stubhub_platform: "on StubHub / viagogo",
      instacart_platform: "on Instacart",
      peloton_platform: "on the Peloton site / app",
    };

    // Allowed channels per category (for override dropdown)
    const CHANNELS_BY_CATEGORY = {
      dining: ["direct"],
      doordash: ["direct"],
      lyft: ["lyft_app"],
      rideshare_other: ["direct"],
      united_flight: ["united"],
      delta_flight_threshold: ["delta"],
      delta_flight: ["delta"],
      other_flight: ["direct", "chase_travel"],
      marriott_hotel: ["direct"],
      renowned_hotel: ["renowned_chase"],
      delta_stays: ["delta_stays_platform"],
      other_hotel: ["direct", "chase_travel"],
      stubhub: ["stubhub_platform"],
      instacart: ["instacart_platform"],
      streaming: ["direct"],
      peloton: ["peloton_platform"],
      other: ["direct"],
    };

    function parseISODate(str) {
      if (!str) return null;
      const d = new Date(str);
      return isNaN(d.getTime()) ? null : d;
    }

    function startOfMonth(d) {
      return new Date(d.getFullYear(), d.getMonth(), 1);
    }

    function loadTransactions() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch {
        return [];
      }
    }

    function saveTransactions(txs) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(txs));
    }

    function renderTransactions() {
      const txs = loadTransactions();
      const tbody = document.getElementById("txTableBody");
      tbody.innerHTML = "";

      txs.forEach((tx) => {
        const tr = document.createElement("tr");
        const tdDate = document.createElement("td");
        const tdAmt = document.createElement("td");
        const tdCat = document.createElement("td");
        const tdChan = document.createElement("td");
        const tdCard = document.createElement("td");

        tdDate.textContent = tx.date || "";
        tdAmt.textContent = `$${Number(tx.amount || 0).toFixed(2)}`;
        tdCat.textContent = tx.category || "";
        tdChan.textContent = tx.channel || "";
        tdCard.textContent = tx.cardUsed || "";

        tr.appendChild(tdDate);
        tr.appendChild(tdAmt);
        tr.appendChild(tdCat);
        tr.appendChild(tdChan);
        tr.appendChild(tdCard);

        tbody.appendChild(tr);
      });
    }

function computeState(txs, now) {
  const nowDate = now || new Date();

  // Month and year boundaries
  const monthStart = startOfMonth(nowDate);
  const yearStart = new Date(nowDate.getFullYear(), 0, 1);

  // Semi-annual StubHub period:
  // Jan–Jun  => period starts Jan 1
  // Jul–Dec  => period starts Jul 1
  const stubhubPeriodStart =
    nowDate.getMonth() < 6
      ? new Date(nowDate.getFullYear(), 0, 1)   // Jan 1
      : new Date(nowDate.getFullYear(), 6, 1);  // Jul 1

  // --- Accumulators ---

  // Monthly
  let mbDiningThisMonth = 0;
  let csrDoordashThisMonth = 0;
  let csrLyftThisMonth = 0;
  let uqRideshareThisMonth = 0;
  let uqInstacartThisMonth = 0;
  let csrPelotonThisMonth = 0;

  // Semi-annual
  let csrStubhubThisPeriod = 0;

  // Annual / calendar-year
  let csrTravelYTD = 0;
  let dgDeltaStaysYTD = 0;
  let dg10kSpendYTD = 0; // all DG spend toward $10k threshold

  // Which categories we treat as "travel" for CSR travel credit tracking
  const CSR_TRAVEL_CATEGORIES = new Set([
    "united_flight",
    "delta_flight_threshold",
    "delta_flight",
    "other_flight",
    "marriott_hotel",
    "renowned_hotel",
    "delta_stays",
    "other_hotel",
    "lyft",
    "rideshare_other",
  ]);

  for (const tx of txs) {
    if (!tx.date) continue;
    const d = parseISODate(tx.date);
    if (!d) continue;

    const amt = Number(tx.amount) || 0;

    const inMonth = d >= monthStart && d <= nowDate;
    const inYear = d >= yearStart && d <= nowDate;
    const inStubhubPeriod = d >= stubhubPeriodStart && d <= nowDate;

    // --- Monthly-limited benefits ---
    if (inMonth) {
      if (tx.cardUsed === "MB" && tx.category === "dining") {
        mbDiningThisMonth += amt;
      }

      if (tx.cardUsed === "CSR" && tx.category === "doordash") {
        csrDoordashThisMonth += amt;
      }

      if (tx.cardUsed === "CSR" && tx.category === "lyft") {
        csrLyftThisMonth += amt;
      }

      if (tx.cardUsed === "UQ" && tx.category === "rideshare_other") {
        uqRideshareThisMonth += amt;
      }

      if (tx.cardUsed === "UQ" && tx.category === "instacart") {
        uqInstacartThisMonth += amt;
      }

      if (tx.cardUsed === "CSR" && tx.category === "peloton") {
        csrPelotonThisMonth += amt;
      }
    }

    // --- Semi-annual StubHub credit (CSR only) ---
    if (
      inStubhubPeriod &&
      tx.cardUsed === "CSR" &&
      tx.category === "stubhub"
    ) {
      csrStubhubThisPeriod += amt;
    }

    // --- Annual / calendar-year benefits ---
    if (inYear) {
      // CSR travel credit – approximate: CSR + travel-ish categories
      if (tx.cardUsed === "CSR" && CSR_TRAVEL_CATEGORIES.has(tx.category)) {
        csrTravelYTD += amt;
      }

      // DG Delta Stays – calendar-year $100 cap
      if (tx.cardUsed === "DG" && tx.category === "delta_stays") {
        dgDeltaStaysYTD += amt;
      }

      // DG $10k threshold – all DG spend, regardless of category
      if (tx.cardUsed === "DG") {
        dg10kSpendYTD += amt;
      }
    }
  }

  return {
    // Monthly
    mbDiningThisMonth,
    csrDoordashThisMonth,
    csrLyftThisMonth,
    uqRideshareThisMonth,
    uqInstacartThisMonth,
    csrPelotonThisMonth,

    // Semi-annual
    csrStubhubThisPeriod,

    // Annual
    csrTravelYTD,
    dgDeltaStaysYTD,
    dg10kSpendYTD,
  };
}

function renderStateSummary() {
  const txs = loadTransactions();
  const state = computeState(txs);
  const el = document.getElementById("stateSummary");

  const lines = [];

  // --- CSR: Travel credit (calendar year, $300) ---
  {
    const used = state.csrTravelYTD;
    const limit = 300;
    const met = used >= limit;
    const text = `<b>CSR Travel (YTD)</b>: ~$${used.toFixed(
      2
    )} of $${limit.toFixed(0)} travel credit (flights/hotels/rideshare on CSR)`;
    const line = met ? `<span class="credit-met">${text}</span>` : text;
    lines.push(line);
  }

  // --- CSR: StubHub semi-annual ($150 per 6-month period) ---
  {
    const used = state.csrStubhubThisPeriod;
    const limit = 150;
    const met = used >= limit;
    const text = `<b>CSR StubHub/viagogo/soccer.com (this 6-month period)</b>: ~$${used.toFixed(
      2
    )} of $${limit.toFixed(0)} semi-annual credit`;
    const line = met ? `<span class="credit-met">${text}</span>` : text;
    lines.push(line);
  }

  // --- CSR: Doordash $5/month ---
  {
    const used = state.csrDoordashThisMonth;
    const limit = 5;
    const met = used >= limit;
    const text = `<b>CSR Doordash (this month)</b>: ~$${used.toFixed(
      2
    )} of $${limit.toFixed(0)} monthly credit`;
    const line = met ? `<span class="credit-met">${text}</span>` : text;
    lines.push(line);
  }

  // --- CSR: Lyft $10/month ---
  {
    const used = state.csrLyftThisMonth;
    const limit = 10;
    const met = used >= limit;
    const text = `<b>CSR Lyft (this month)</b>: ~$${used.toFixed(
      2
    )} of $${limit.toFixed(0)} monthly credit`;
    const line = met ? `<span class="credit-met">${text}</span>` : text;
    lines.push(line);
  }

  // --- CSR: Peloton $10/month ---
  {
    const used = state.csrPelotonThisMonth;
    const limit = 10;
    const met = used >= limit;
    const text = `<b>CSR Peloton membership (this month)</b>: ~$${used.toFixed(
      2
    )} of $${limit.toFixed(0)} monthly credit`;
    const line = met ? `<span class="credit-met">${text}</span>` : text;
    lines.push(line);
  }

  // --- UQ: Rideshare $8/month ---
  {
    const used = state.uqRideshareThisMonth;
    const limit = 8;
    const met = used >= limit;
    const text = `<b>UQ rideshare (other) (this month)</b>: ~$${used.toFixed(
      2
    )} of $${limit.toFixed(0)} monthly credit`;
    const line = met ? `<span class="credit-met">${text}</span>` : text;
    lines.push(line);
  }

  // --- UQ: Instacart $15/month ---
  {
    const used = state.uqInstacartThisMonth;
    const limit = 15;
    const met = used >= limit;
    const text = `<b>UQ Instacart (this month)</b>: ~$${used.toFixed(
      2
    )} of $${limit.toFixed(0)} monthly credit`;
    const line = met ? `<span class="credit-met">${text}</span>` : text;
    lines.push(line);
  }

  // --- MB: Dining $25/month ---
  {
    const used = state.mbDiningThisMonth;
    const limit = 25;
    const met = used >= limit;
    const text = `<b>MB dining (this month)</b>: ~$${used.toFixed(
      2
    )} of $${limit.toFixed(0)} monthly dining credit`;
    const line = met ? `<span class="credit-met">${text}</span>` : text;
    lines.push(line);
  }

  // --- DG: Delta Stays $100/year ---
  {
    const used = state.dgDeltaStaysYTD;
    const limit = 100;
    const met = used >= limit;
    const text = `<b>DG Delta Stays (YTD)</b>: ~$${used.toFixed(
      2
    )} of $${limit.toFixed(0)} annual Delta Stays credit`;
    const line = met ? `<span class="credit-met">${text}</span>` : text;
    lines.push(line);
  }

  // --- DG: $10k spend threshold for $200 Delta Flight Credit ---
  {
    const used = state.dg10kSpendYTD;
    const limit = 10000;
    const met = used >= limit;
    const text = `<b>DG $10k threshold (YTD)</b>: ~$${used.toFixed(
      2
    )} of $${limit.toFixed(0)} eligible spend toward the $200 Delta Flight Credit`;
    const line = met ? `<span class="credit-met">${text}</span>` : text;
    lines.push(line);
  }

  el.innerHTML =
    "<ul>" + lines.map((line) => `<li>${line}</li>`).join("") + "</ul>";
}

    // ---------- UPDATED recommendCard: decides both card AND channel ----------
function recommendCard(purchase, state) {
  const { category } = purchase;
  const amount = Number(purchase.amount) || 0;

  // ---- DINING ----
  // 1) MB: $25/month dining credit.
  // 2) CSR: then becomes default for dining.
  if (category === "dining") {
    if (state.mbDiningThisMonth < 25) {
      return {
        card: "MB",
        channel: "direct",
        reason: `MB: use Brilliant first to burn the $25 monthly dining credit (you’ve logged ~$${state.mbDiningThisMonth.toFixed(
          2
        )} so far this month).`,
      };
    }
    return {
      card: "CSR",
      channel: "direct",
      reason:
        "CSR: MB dining credit looks used up for this month; default to CSR for flexible points and your stated preference.",
    };
  }

  // ---- DOORDASH ----
  // 1) CSR: $5/month Doordash credit.
  // 2) CSR: then default for food delivery.
  if (category === "doordash") {
    if (state.csrDoordashThisMonth < 5) {
      return {
        card: "CSR",
        channel: "direct",
        reason: `CSR: use CSR first to burn the $5 monthly Doordash/food-delivery credit (you’ve logged ~$${state.csrDoordashThisMonth.toFixed(
          2
        )} so far this month).`,
      };
    }
    return {
      card: "CSR",
      channel: "direct",
      reason:
        "CSR: Doordash monthly credit is effectively used; still default to CSR for flexible points here.",
    };
  }

  // ---- LYFT ----
  // 1) CSR: $10/month Lyft credit + boosted Lyft earn.
  if (category === "lyft") {
    if (state.csrLyftThisMonth < 10) {
      return {
        card: "CSR",
        channel: "lyft_app",
        reason: `CSR: Lyft has about $${(
          10 - state.csrLyftThisMonth
        ).toFixed(
          2
        )} of the $10 monthly CSR Lyft credit left, plus boosted points on Lyft.`,
      };
    }
    return {
      card: "CSR",
      channel: "lyft_app",
      reason:
        "CSR: Lyft monthly credit looks used, but CSR still wins here thanks to Lyft boosts and flexibility.",
    };
  }

  // ---- OTHER RIDESHARE (Uber etc.) ----
  // 1) UQ: $8/month rideshare credit.
  // 2) CSR fallback.
  if (category === "rideshare_other") {
    if (state.uqRideshareThisMonth < 8) {
      return {
        card: "UQ",
        channel: "direct",
        reason: `UQ: use United Quest first to burn the $8 monthly rideshare credit (you’ve logged ~$${state.uqRideshareThisMonth.toFixed(
          2
        )} so far this month).`,
      };
    }
    return {
      card: "CSR",
      channel: "direct",
      reason:
        "CSR: UQ rideshare monthly credit looks used; default to CSR for flexible points.",
    };
  }

  // ---- UNITED FLIGHTS ----
  // You chose: prioritize United loyalty/perks over pure cents-per-point.
  if (category === "united_flight") {
    return {
      card: "UQ",
      channel: "united",
      reason:
        "UQ: For United flights, use United Quest to get miles, free bags/priority boarding, TravelBank benefits, and PQPs.",
    };
  }

  // ---- DELTA FLIGHTS – threshold chasing ----
  // Use DG while you're still below $10k YTD; otherwise treat like a normal Delta flight.
  if (category === "delta_flight_threshold") {
    const remaining = Math.max(0, 10000 - state.dg10kSpendYTD);
    if (state.dg10kSpendYTD < 10000) {
      return {
        card: "DG",
        channel: "delta",
        reason: `DG: You marked this as threshold-chasing and you’ve logged ~$${state.dg10kSpendYTD.toFixed(
          2
        )} toward the $10,000 YTD spend. Roughly $${remaining.toFixed(
          2
        )} to go; use Delta Gold here to work toward the $200 Delta Flight Credit.`,
      };
    }
    return {
      card: "CSR",
      channel: "delta",
      reason:
        "CSR: You’ve effectively hit the $10k Delta Gold spend threshold this year; treat this like a normal Delta flight and default to CSR for flexibility.",
    };
  }

  // ---- DELTA FLIGHTS – normal ----
  if (category === "delta_flight") {
    return {
      card: "CSR",
      channel: "delta",
      reason:
        "CSR: Delta flight booked direct and you’re not treating it as threshold-chasing; default to CSR for travel earn and flexibility.",
    };
  }

  // ---- OTHER FLIGHTS ----
  if (category === "other_flight") {
    return {
      card: "CSR",
      channel: "chase_travel",
      reason:
        "CSR: Other airline – book via Chase Travel with CSR to keep travel earn in flexible points (no special airline perks dominating).",
    };
  }

  // ---- MARRIOTT HOTELS ----
  if (category === "marriott_hotel") {
    return {
      card: "MB",
      channel: "direct",
      reason:
        "MB: Direct Marriott stay – use Brilliant for 6x Bonvoy points plus status alignment and Marriott-specific perks.",
    };
  }

  // ---- RENOWNED HOTELS (United program) ----
  if (category === "renowned_hotel") {
    return {
      card: "UQ",
      channel: "renowned_chase",
      reason:
        "UQ: Renowned Hotels booking – use United Quest to trigger the Renowned credit and boosted United earn.",
    };
  }

  // ---- DELTA STAYS ----
  // $100 annual Delta Stays credit.
  if (category === "delta_stays") {
    if (state.dgDeltaStaysYTD < 100) {
      const remaining = Math.max(0, 100 - state.dgDeltaStaysYTD);
      return {
        card: "DG",
        channel: "delta_stays_platform",
        reason: `DG: Use Delta Gold at Delta Stays until you’ve used the $100 annual credit (you’ve logged ~$${state.dgDeltaStaysYTD.toFixed(
          2
        )}, about $${remaining.toFixed(2)} remaining).`,
      };
    }
    return {
      card: "CSR",
      channel: "delta_stays_platform",
      reason:
        "CSR: Delta Stays annual credit looks used; defaulting to CSR for flexible travel points.",
    };
  }

  // ---- OTHER HOTELS / LODGING ----
  if (category === "other_hotel") {
    return {
      card: "CSR",
      channel: "chase_travel",
      reason:
        "CSR: Non-Marriott hotel – book via Chase Travel with CSR to centralize travel earn in flexible points.",
    };
  }

  // ---- STUBHUB / VIAGOGO / SOCCER.COM ----
  // CSR: $150 semi-annual credit.
  if (category === "stubhub") {
    if (state.csrStubhubThisPeriod < 150) {
      const remaining = Math.max(0, 150 - state.csrStubhubThisPeriod);
      return {
        card: "CSR",
        channel: "stubhub_platform",
        reason: `CSR: Use CSR on StubHub/viagogo/soccer.com to work through the $150 semi-annual credit (you’ve logged ~$${state.csrStubhubThisPeriod.toFixed(
          2
        )}, about $${remaining.toFixed(2)} remaining this period).`,
      };
    }
    return {
      card: "CSR",
      channel: "stubhub_platform",
      reason:
        "CSR: StubHub semi-annual credit looks used; CSR still wins here as default for flexibility.",
    };
  }

  // ---- INSTACART ----
  // UQ: $15/month Instacart.
  if (category === "instacart") {
    if (state.uqInstacartThisMonth < 15) {
      const remaining = Math.max(0, 15 - state.uqInstacartThisMonth);
      return {
        card: "UQ",
        channel: "instacart_platform",
        reason: `UQ: Use United Quest for Instacart to burn through the $15 monthly Instacart credits (you’ve logged ~$${state.uqInstacartThisMonth.toFixed(
          2
        )}, about $${remaining.toFixed(2)} remaining).`,
      };
    }
    return {
      card: "CSR",
      channel: "instacart_platform",
      reason:
        "CSR: Instacart monthly credits look used; defaulting to CSR for flexible points.",
    };
  }

  // ---- STREAMING ----
  if (category === "streaming") {
    return {
      card: "UQ",
      channel: "direct",
      reason:
        "UQ: Streaming earns bonus miles on United Quest; after that, CSR stays your general default elsewhere.",
    };
  }

  // ---- PELOTON MEMBERSHIP ----
  // CSR: $10/month Peloton membership credit.
  if (category === "peloton") {
    if (state.csrPelotonThisMonth < 10) {
      const remaining = Math.max(0, 10 - state.csrPelotonThisMonth);
      return {
        card: "CSR",
        channel: "peloton_platform",
        reason: `CSR: Use CSR for Peloton membership to consume the $10 monthly credit (you’ve logged ~$${state.csrPelotonThisMonth.toFixed(
          2
        )}, about $${remaining.toFixed(2)} remaining).`,
      };
    }
    return {
      card: "CSR",
      channel: "peloton_platform",
      reason:
        "CSR: Peloton membership monthly credit looks used; CSR remains your default here for simplicity.",
    };
  }

  // ---- GENERAL / FALLBACK ----
  return {
    card: "CSR",
    channel: "direct",
    reason:
      "CSR: No special time-bound credit or category perk dominates here, so defaulting to CSR as you requested.",
  };
}


    // ---------- UI wiring ----------

    let lastRecommendation = null;

    function initFormDefaults() {
      const dateInput = document.getElementById("date");
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      dateInput.value = `${yyyy}-${mm}-${dd}`;
    }

    document.getElementById("btnRecommend").addEventListener("click", () => {
      const amount = document.getElementById("amount").value;
      const date = document.getElementById("date").value;
      const category = document.getElementById("category").value;

      if (!amount || !date) {
        alert("Please enter amount and date.");
        return;
      }

      const purchase = {
        amount,
        date,
        category,
      };

      const txs = loadTransactions();
      const state = computeState(txs);
      const rec = recommendCard(purchase, state);
      lastRecommendation = { purchase, rec };

      const channelLabel = CHANNEL_LABELS[rec.channel] || rec.channel;
      document.getElementById("recommendationBox").textContent =
        `Recommended: ${rec.card} – ${channelLabel}`;
      document.getElementById("reasonBox").textContent = rec.reason;
      document.getElementById("recommendationSection").style.display = "block";

      // Pre-select recommended in override dropdowns
      const cardSel = document.getElementById("cardUsedSelect");
      cardSel.value = "";

      const chanSelect = document.getElementById("channelUsedSelect");
      chanSelect.innerHTML = "";

      const relevantChannels = CHANNELS_BY_CATEGORY[category] || ["direct"];
      relevantChannels.forEach((code) => {
        const opt = document.createElement("option");
        opt.value = code;
        opt.textContent = CHANNEL_LABELS[code] || code;
        chanSelect.appendChild(opt);
      });

      // If recommended channel is in list, select it; otherwise leave first option
      if (relevantChannels.includes(rec.channel)) {
        chanSelect.value = rec.channel;
      }
    });

    document.getElementById("btnSaveTx").addEventListener("click", () => {
      if (!lastRecommendation) {
        alert("Get a recommendation first.");
        return;
      }
      const overrideCard = document.getElementById("cardUsedSelect").value;
      const overrideChannel = document.getElementById("channelUsedSelect").value;

      const cardUsed = overrideCard || lastRecommendation.rec.card;
      const channelUsed = overrideChannel || lastRecommendation.rec.channel;

      const tx = {
        date: lastRecommendation.purchase.date,
        amount: lastRecommendation.purchase.amount,
        category: lastRecommendation.purchase.category,
        channel: channelUsed,
        cardUsed,
      };

      const txs = loadTransactions();
      txs.push(tx);
      saveTransactions(txs);
      renderTransactions();
      renderStateSummary();

      alert("Purchase saved.");
    });

        document.getElementById("btnReset").addEventListener("click", () => {
      // Clear amount
      document.getElementById("amount").value = "";

      // Reset date to today
      initFormDefaults();

      // Reset category to default (first option: dining)
      document.getElementById("category").value = "dining";

      // Hide recommendation section and clear its content
      document.getElementById("recommendationSection").style.display = "none";
      document.getElementById("recommendationBox").textContent = "";
      document.getElementById("reasonBox").textContent = "";

      // Reset override dropdowns
      document.getElementById("cardUsedSelect").value = "";
      const chanSelect = document.getElementById("channelUsedSelect");
      chanSelect.innerHTML = "";

      // Clear last recommendation state
      lastRecommendation = null;
    });


    document.getElementById("btnClear").addEventListener("click", () => {
      if (!confirm("Clear all logged purchases?")) return;
      saveTransactions([]);
      renderTransactions();
      renderStateSummary();
    });

        // Show/Hide Logged Purchases section
    const logContent = document.getElementById("logContent");
    const toggleLogBtn = document.getElementById("toggleLogBtn");

    toggleLogBtn.addEventListener("click", () => {
      const isHidden =
        logContent.style.display === "none" || logContent.style.display === "";

      if (isHidden) {
        logContent.style.display = "block";
        toggleLogBtn.textContent = "Hide";
      } else {
        logContent.style.display = "none";
        toggleLogBtn.textContent = "Show";
      }
    });

    // Init on load
    initFormDefaults();
    renderTransactions();
    renderStateSummary();
  </script>
</body>
</html>
